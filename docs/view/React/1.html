<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React 设计模式读书笔记 | 追境的笔记</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="追境的笔记，曹泽鹏读书笔记,VUE,Vue,JS,REACT,React,TypeScript,TS,Node,NodeJs,Mongodb,Koa,算法">
    
    <link rel="preload" href="/assets/css/0.styles.836f89b8.css" as="style"><link rel="preload" href="/assets/js/app.fd8d9560.js" as="script"><link rel="preload" href="/assets/js/2.a8ceb4c3.js" as="script"><link rel="preload" href="/assets/js/1.927044d1.js" as="script"><link rel="preload" href="/assets/js/209.e0c2863e.js" as="script"><link rel="prefetch" href="/assets/js/10.56cd1adf.js"><link rel="prefetch" href="/assets/js/100.cc2d3b0a.js"><link rel="prefetch" href="/assets/js/101.97c3d73b.js"><link rel="prefetch" href="/assets/js/102.b64787ef.js"><link rel="prefetch" href="/assets/js/103.44f5a929.js"><link rel="prefetch" href="/assets/js/104.26b2ab50.js"><link rel="prefetch" href="/assets/js/105.c529bc88.js"><link rel="prefetch" href="/assets/js/106.5fb1cec9.js"><link rel="prefetch" href="/assets/js/107.f808dedd.js"><link rel="prefetch" href="/assets/js/108.c66adf98.js"><link rel="prefetch" href="/assets/js/109.141a5d10.js"><link rel="prefetch" href="/assets/js/11.f128e43e.js"><link rel="prefetch" href="/assets/js/110.af0109ac.js"><link rel="prefetch" href="/assets/js/111.4ec69a60.js"><link rel="prefetch" href="/assets/js/112.58d7ee74.js"><link rel="prefetch" href="/assets/js/113.4735fb27.js"><link rel="prefetch" href="/assets/js/114.29bca941.js"><link rel="prefetch" href="/assets/js/115.c2a1c204.js"><link rel="prefetch" href="/assets/js/116.d823be08.js"><link rel="prefetch" href="/assets/js/117.ebc2ebbb.js"><link rel="prefetch" href="/assets/js/118.fc0b7187.js"><link rel="prefetch" href="/assets/js/119.733a2861.js"><link rel="prefetch" href="/assets/js/12.29115c3e.js"><link rel="prefetch" href="/assets/js/120.524f8c15.js"><link rel="prefetch" href="/assets/js/121.e0459738.js"><link rel="prefetch" href="/assets/js/122.c915c1b2.js"><link rel="prefetch" href="/assets/js/123.1d21efd8.js"><link rel="prefetch" href="/assets/js/124.9c4f0dfa.js"><link rel="prefetch" href="/assets/js/125.0a634e8d.js"><link rel="prefetch" href="/assets/js/126.60cb9538.js"><link rel="prefetch" href="/assets/js/127.02d68879.js"><link rel="prefetch" href="/assets/js/128.7cb7a688.js"><link rel="prefetch" href="/assets/js/129.08a11fcc.js"><link rel="prefetch" href="/assets/js/13.73219fa5.js"><link rel="prefetch" href="/assets/js/130.776336d6.js"><link rel="prefetch" href="/assets/js/131.b2e42307.js"><link rel="prefetch" href="/assets/js/132.0220eea1.js"><link rel="prefetch" href="/assets/js/133.70b459ad.js"><link rel="prefetch" href="/assets/js/134.3ccee10d.js"><link rel="prefetch" href="/assets/js/135.5ab5e11e.js"><link rel="prefetch" href="/assets/js/136.aedce19c.js"><link rel="prefetch" href="/assets/js/137.a45c9e8a.js"><link rel="prefetch" href="/assets/js/138.3e10707a.js"><link rel="prefetch" href="/assets/js/139.d8287870.js"><link rel="prefetch" href="/assets/js/14.1e3249a2.js"><link rel="prefetch" href="/assets/js/140.7643611d.js"><link rel="prefetch" href="/assets/js/141.35967df0.js"><link rel="prefetch" href="/assets/js/142.99ce761e.js"><link rel="prefetch" href="/assets/js/143.896e57b4.js"><link rel="prefetch" href="/assets/js/144.91a3e940.js"><link rel="prefetch" href="/assets/js/145.87622968.js"><link rel="prefetch" href="/assets/js/146.e1248809.js"><link rel="prefetch" href="/assets/js/147.375f86c0.js"><link rel="prefetch" href="/assets/js/148.479a56ee.js"><link rel="prefetch" href="/assets/js/149.c2705153.js"><link rel="prefetch" href="/assets/js/15.dfc087cd.js"><link rel="prefetch" href="/assets/js/150.d5bc0262.js"><link rel="prefetch" href="/assets/js/151.6469ba8e.js"><link rel="prefetch" href="/assets/js/152.78d4b837.js"><link rel="prefetch" href="/assets/js/153.1eb1feb8.js"><link rel="prefetch" href="/assets/js/154.6f9b7313.js"><link rel="prefetch" href="/assets/js/155.a31afbab.js"><link rel="prefetch" href="/assets/js/156.6392d772.js"><link rel="prefetch" href="/assets/js/157.a3dce19a.js"><link rel="prefetch" href="/assets/js/158.7bc06d4a.js"><link rel="prefetch" href="/assets/js/159.b4d0f2e6.js"><link rel="prefetch" href="/assets/js/16.5c0c235b.js"><link rel="prefetch" href="/assets/js/160.6c6f8aee.js"><link rel="prefetch" href="/assets/js/161.747183de.js"><link rel="prefetch" href="/assets/js/162.ae99eb7b.js"><link rel="prefetch" href="/assets/js/163.1ed08d72.js"><link rel="prefetch" href="/assets/js/164.edc31f1a.js"><link rel="prefetch" href="/assets/js/165.9c581936.js"><link rel="prefetch" href="/assets/js/166.ed8a0b2b.js"><link rel="prefetch" href="/assets/js/167.572eeec2.js"><link rel="prefetch" href="/assets/js/168.ab91ee50.js"><link rel="prefetch" href="/assets/js/169.3e90ea0e.js"><link rel="prefetch" href="/assets/js/17.c44bbb0c.js"><link rel="prefetch" href="/assets/js/170.b84bb809.js"><link rel="prefetch" href="/assets/js/171.f9cdf83b.js"><link rel="prefetch" href="/assets/js/172.c4f780f1.js"><link rel="prefetch" href="/assets/js/173.202b93d9.js"><link rel="prefetch" href="/assets/js/174.8a140cdf.js"><link rel="prefetch" href="/assets/js/175.617e56f5.js"><link rel="prefetch" href="/assets/js/176.1e085e4c.js"><link rel="prefetch" href="/assets/js/177.1b1ba652.js"><link rel="prefetch" href="/assets/js/178.c1704ec7.js"><link rel="prefetch" href="/assets/js/179.c8ba29da.js"><link rel="prefetch" href="/assets/js/18.6c0e1ac3.js"><link rel="prefetch" href="/assets/js/180.80d92c1b.js"><link rel="prefetch" href="/assets/js/181.b8e25358.js"><link rel="prefetch" href="/assets/js/182.86c4225c.js"><link rel="prefetch" href="/assets/js/183.6f19ba93.js"><link rel="prefetch" href="/assets/js/184.09ec790d.js"><link rel="prefetch" href="/assets/js/185.8cca5412.js"><link rel="prefetch" href="/assets/js/186.8c874075.js"><link rel="prefetch" href="/assets/js/187.83f9597b.js"><link rel="prefetch" href="/assets/js/188.1bf8422c.js"><link rel="prefetch" href="/assets/js/189.fa0bc624.js"><link rel="prefetch" href="/assets/js/19.3177b1a2.js"><link rel="prefetch" href="/assets/js/190.e3fe1bbb.js"><link rel="prefetch" href="/assets/js/191.cd916be2.js"><link rel="prefetch" href="/assets/js/192.16637ce9.js"><link rel="prefetch" href="/assets/js/193.6674b7b0.js"><link rel="prefetch" href="/assets/js/194.4e12f0a8.js"><link rel="prefetch" href="/assets/js/195.cdc83dc3.js"><link rel="prefetch" href="/assets/js/196.e4f775bc.js"><link rel="prefetch" href="/assets/js/197.59ad6f9c.js"><link rel="prefetch" href="/assets/js/198.30e73199.js"><link rel="prefetch" href="/assets/js/199.a32bf848.js"><link rel="prefetch" href="/assets/js/20.20000c42.js"><link rel="prefetch" href="/assets/js/200.c13698ce.js"><link rel="prefetch" href="/assets/js/201.94f87f99.js"><link rel="prefetch" href="/assets/js/202.690f3daa.js"><link rel="prefetch" href="/assets/js/203.418f60ae.js"><link rel="prefetch" href="/assets/js/204.da33e97b.js"><link rel="prefetch" href="/assets/js/205.ca20f433.js"><link rel="prefetch" href="/assets/js/206.46439c6e.js"><link rel="prefetch" href="/assets/js/207.a597ba5f.js"><link rel="prefetch" href="/assets/js/208.7ca36754.js"><link rel="prefetch" href="/assets/js/21.98f5e4bd.js"><link rel="prefetch" href="/assets/js/210.477e5fd8.js"><link rel="prefetch" href="/assets/js/211.226c581a.js"><link rel="prefetch" href="/assets/js/212.76603a75.js"><link rel="prefetch" href="/assets/js/213.a5900811.js"><link rel="prefetch" href="/assets/js/214.c985b747.js"><link rel="prefetch" href="/assets/js/215.52732c01.js"><link rel="prefetch" href="/assets/js/216.1173fca7.js"><link rel="prefetch" href="/assets/js/217.da7c3991.js"><link rel="prefetch" href="/assets/js/218.fcaf4dcd.js"><link rel="prefetch" href="/assets/js/219.9b887510.js"><link rel="prefetch" href="/assets/js/22.bd2814cf.js"><link rel="prefetch" href="/assets/js/220.4df72fe0.js"><link rel="prefetch" href="/assets/js/221.cc196e79.js"><link rel="prefetch" href="/assets/js/222.df466d7a.js"><link rel="prefetch" href="/assets/js/223.a48bc145.js"><link rel="prefetch" href="/assets/js/224.0d6ed56d.js"><link rel="prefetch" href="/assets/js/225.16ea0fae.js"><link rel="prefetch" href="/assets/js/226.747347e7.js"><link rel="prefetch" href="/assets/js/227.76d20161.js"><link rel="prefetch" href="/assets/js/228.3be70d9d.js"><link rel="prefetch" href="/assets/js/229.79619c95.js"><link rel="prefetch" href="/assets/js/23.44cc6365.js"><link rel="prefetch" href="/assets/js/230.c7e1e910.js"><link rel="prefetch" href="/assets/js/231.cd19b997.js"><link rel="prefetch" href="/assets/js/232.f3677800.js"><link rel="prefetch" href="/assets/js/233.6a75bdca.js"><link rel="prefetch" href="/assets/js/234.ec5aab7c.js"><link rel="prefetch" href="/assets/js/235.b39a4730.js"><link rel="prefetch" href="/assets/js/236.9c9db163.js"><link rel="prefetch" href="/assets/js/237.cba060cd.js"><link rel="prefetch" href="/assets/js/238.63285ab0.js"><link rel="prefetch" href="/assets/js/239.45306103.js"><link rel="prefetch" href="/assets/js/24.3fe38b2b.js"><link rel="prefetch" href="/assets/js/240.31a1e9d9.js"><link rel="prefetch" href="/assets/js/241.40b2678e.js"><link rel="prefetch" href="/assets/js/242.c5261d15.js"><link rel="prefetch" href="/assets/js/243.dda51749.js"><link rel="prefetch" href="/assets/js/244.40e9a224.js"><link rel="prefetch" href="/assets/js/245.172b72b8.js"><link rel="prefetch" href="/assets/js/246.f4bf2b8b.js"><link rel="prefetch" href="/assets/js/247.381b3d4c.js"><link rel="prefetch" href="/assets/js/248.83c22482.js"><link rel="prefetch" href="/assets/js/249.b13c98c6.js"><link rel="prefetch" href="/assets/js/25.574d473e.js"><link rel="prefetch" href="/assets/js/250.86272c67.js"><link rel="prefetch" href="/assets/js/251.7b0d3241.js"><link rel="prefetch" href="/assets/js/252.b10e1f56.js"><link rel="prefetch" href="/assets/js/253.8f4bb3a7.js"><link rel="prefetch" href="/assets/js/254.b5aa9387.js"><link rel="prefetch" href="/assets/js/255.87f541da.js"><link rel="prefetch" href="/assets/js/256.d2fe07e6.js"><link rel="prefetch" href="/assets/js/257.2fa67cf4.js"><link rel="prefetch" href="/assets/js/258.6d979783.js"><link rel="prefetch" href="/assets/js/259.a9081785.js"><link rel="prefetch" href="/assets/js/26.6555bc5a.js"><link rel="prefetch" href="/assets/js/260.612f809e.js"><link rel="prefetch" href="/assets/js/261.4ef9345d.js"><link rel="prefetch" href="/assets/js/262.cce7f355.js"><link rel="prefetch" href="/assets/js/263.01a325c0.js"><link rel="prefetch" href="/assets/js/264.d3e4d6b9.js"><link rel="prefetch" href="/assets/js/265.21b8aba4.js"><link rel="prefetch" href="/assets/js/266.fc4b3ec7.js"><link rel="prefetch" href="/assets/js/267.9ba7401f.js"><link rel="prefetch" href="/assets/js/268.04157d77.js"><link rel="prefetch" href="/assets/js/269.15cbdf50.js"><link rel="prefetch" href="/assets/js/27.7c633283.js"><link rel="prefetch" href="/assets/js/270.ef05f552.js"><link rel="prefetch" href="/assets/js/271.f0cbe3d0.js"><link rel="prefetch" href="/assets/js/272.ba0996f7.js"><link rel="prefetch" href="/assets/js/273.a6122cf2.js"><link rel="prefetch" href="/assets/js/274.faaefba3.js"><link rel="prefetch" href="/assets/js/275.ad936532.js"><link rel="prefetch" href="/assets/js/276.64785d9f.js"><link rel="prefetch" href="/assets/js/277.3dd2fa80.js"><link rel="prefetch" href="/assets/js/278.d3d5c86b.js"><link rel="prefetch" href="/assets/js/279.1d4276d2.js"><link rel="prefetch" href="/assets/js/28.292c8353.js"><link rel="prefetch" href="/assets/js/280.6cd49a63.js"><link rel="prefetch" href="/assets/js/281.715961c3.js"><link rel="prefetch" href="/assets/js/282.1337cc52.js"><link rel="prefetch" href="/assets/js/283.50e22ce9.js"><link rel="prefetch" href="/assets/js/284.8cd1d1f9.js"><link rel="prefetch" href="/assets/js/285.3e933659.js"><link rel="prefetch" href="/assets/js/286.025e2577.js"><link rel="prefetch" href="/assets/js/287.59179204.js"><link rel="prefetch" href="/assets/js/288.45a5351b.js"><link rel="prefetch" href="/assets/js/289.77217f4f.js"><link rel="prefetch" href="/assets/js/29.88aef704.js"><link rel="prefetch" href="/assets/js/290.ab6141a8.js"><link rel="prefetch" href="/assets/js/291.01ae8256.js"><link rel="prefetch" href="/assets/js/292.85ac236c.js"><link rel="prefetch" href="/assets/js/293.62b82fc2.js"><link rel="prefetch" href="/assets/js/294.c0a974f5.js"><link rel="prefetch" href="/assets/js/295.1b255727.js"><link rel="prefetch" href="/assets/js/296.7362b4f3.js"><link rel="prefetch" href="/assets/js/297.91123b93.js"><link rel="prefetch" href="/assets/js/298.7f51d9d0.js"><link rel="prefetch" href="/assets/js/299.234837a0.js"><link rel="prefetch" href="/assets/js/3.bb4be087.js"><link rel="prefetch" href="/assets/js/30.d7970726.js"><link rel="prefetch" href="/assets/js/300.381f4892.js"><link rel="prefetch" href="/assets/js/301.162bd2f5.js"><link rel="prefetch" href="/assets/js/302.dd64a74a.js"><link rel="prefetch" href="/assets/js/31.9b99c37f.js"><link rel="prefetch" href="/assets/js/32.c1bdfec7.js"><link rel="prefetch" href="/assets/js/33.20494542.js"><link rel="prefetch" href="/assets/js/34.bae4db4b.js"><link rel="prefetch" href="/assets/js/35.b75ce883.js"><link rel="prefetch" href="/assets/js/36.533b534d.js"><link rel="prefetch" href="/assets/js/37.b2324a5f.js"><link rel="prefetch" href="/assets/js/38.a734e52d.js"><link rel="prefetch" href="/assets/js/39.9e45ce9f.js"><link rel="prefetch" href="/assets/js/4.fadd3e21.js"><link rel="prefetch" href="/assets/js/40.00dad40c.js"><link rel="prefetch" href="/assets/js/41.23b86bd5.js"><link rel="prefetch" href="/assets/js/42.e0c30dbe.js"><link rel="prefetch" href="/assets/js/43.ba851003.js"><link rel="prefetch" href="/assets/js/44.854cceaf.js"><link rel="prefetch" href="/assets/js/45.598dbbc7.js"><link rel="prefetch" href="/assets/js/46.5197c7ea.js"><link rel="prefetch" href="/assets/js/47.370afd90.js"><link rel="prefetch" href="/assets/js/48.22bd1755.js"><link rel="prefetch" href="/assets/js/49.83ca8e9c.js"><link rel="prefetch" href="/assets/js/5.df1ec49c.js"><link rel="prefetch" href="/assets/js/50.65783202.js"><link rel="prefetch" href="/assets/js/51.23775309.js"><link rel="prefetch" href="/assets/js/52.3f6a15d5.js"><link rel="prefetch" href="/assets/js/53.eb42ce0e.js"><link rel="prefetch" href="/assets/js/54.af48455b.js"><link rel="prefetch" href="/assets/js/55.f84e3d27.js"><link rel="prefetch" href="/assets/js/56.d914b1e8.js"><link rel="prefetch" href="/assets/js/57.2eff679f.js"><link rel="prefetch" href="/assets/js/58.8edbe185.js"><link rel="prefetch" href="/assets/js/59.fd97ee01.js"><link rel="prefetch" href="/assets/js/6.8643a830.js"><link rel="prefetch" href="/assets/js/60.4e1f1b2e.js"><link rel="prefetch" href="/assets/js/61.bbd6e012.js"><link rel="prefetch" href="/assets/js/62.f482bfc9.js"><link rel="prefetch" href="/assets/js/63.d15146d3.js"><link rel="prefetch" href="/assets/js/64.65663bee.js"><link rel="prefetch" href="/assets/js/65.8054d10f.js"><link rel="prefetch" href="/assets/js/66.e6456c1b.js"><link rel="prefetch" href="/assets/js/67.b9316331.js"><link rel="prefetch" href="/assets/js/68.3df72855.js"><link rel="prefetch" href="/assets/js/69.36f7d25c.js"><link rel="prefetch" href="/assets/js/7.cdb60884.js"><link rel="prefetch" href="/assets/js/70.3825b61a.js"><link rel="prefetch" href="/assets/js/71.2a0982e7.js"><link rel="prefetch" href="/assets/js/72.3c65050f.js"><link rel="prefetch" href="/assets/js/73.48d55a44.js"><link rel="prefetch" href="/assets/js/74.680660e7.js"><link rel="prefetch" href="/assets/js/75.442f9dd8.js"><link rel="prefetch" href="/assets/js/76.166609c3.js"><link rel="prefetch" href="/assets/js/77.36777526.js"><link rel="prefetch" href="/assets/js/78.46be22c5.js"><link rel="prefetch" href="/assets/js/79.b730fbaa.js"><link rel="prefetch" href="/assets/js/80.31b248e5.js"><link rel="prefetch" href="/assets/js/81.bb0bdfa2.js"><link rel="prefetch" href="/assets/js/82.bcedef67.js"><link rel="prefetch" href="/assets/js/83.13a1001b.js"><link rel="prefetch" href="/assets/js/84.659250ff.js"><link rel="prefetch" href="/assets/js/85.26e267d0.js"><link rel="prefetch" href="/assets/js/86.1d948c8e.js"><link rel="prefetch" href="/assets/js/87.a475c581.js"><link rel="prefetch" href="/assets/js/88.40912474.js"><link rel="prefetch" href="/assets/js/89.68010552.js"><link rel="prefetch" href="/assets/js/90.38ac8e73.js"><link rel="prefetch" href="/assets/js/91.abe62ba0.js"><link rel="prefetch" href="/assets/js/92.f52771f1.js"><link rel="prefetch" href="/assets/js/93.90ec717c.js"><link rel="prefetch" href="/assets/js/94.a1852ddb.js"><link rel="prefetch" href="/assets/js/95.3f4aee8d.js"><link rel="prefetch" href="/assets/js/96.20dfd078.js"><link rel="prefetch" href="/assets/js/97.5f8def65.js"><link rel="prefetch" href="/assets/js/98.9729e9c1.js"><link rel="prefetch" href="/assets/js/99.bb2e143d.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.fc117b08.js">
    <link rel="stylesheet" href="/assets/css/0.styles.836f89b8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">追境的笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="tel:13545253491" class="nav-link external">
  联系我
  <!----></a></div><div class="nav-item"><a href="/view/Vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/view/React/" class="nav-link router-link-active">
  React
</a></div><div class="nav-item"><a href="/view/Vue3.0/" class="nav-link">
  Vue3.0.0
</a></div><div class="nav-item"><a href="/view/Other/16.html" class="nav-link">
  网站分类
</a></div><div class="nav-item"><a href="/view/Tools.html" class="nav-link">
  工具
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="tel:13545253491" class="nav-link external">
  联系我
  <!----></a></div><div class="nav-item"><a href="/view/Vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/view/React/" class="nav-link router-link-active">
  React
</a></div><div class="nav-item"><a href="/view/Vue3.0/" class="nav-link">
  Vue3.0.0
</a></div><div class="nav-item"><a href="/view/Other/16.html" class="nav-link">
  网站分类
</a></div><div class="nav-item"><a href="/view/Tools.html" class="nav-link">
  工具
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/view/Vue3.0/" class="sidebar-heading clickable"><span>Vue3.0</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/view/React/" class="sidebar-heading clickable router-link-active open"><span>React</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/view/React/6.html" class="sidebar-link">新学React 18.2</a></li><li><a href="/view/React/5.html" class="sidebar-link">React Fiber</a></li><li><a href="/view/React/4.html" class="sidebar-link">高阶组件</a></li><li><a href="/view/React/3.html" class="sidebar-link">注意事项</a></li><li><a href="/view/React/2.html" class="sidebar-link">Hook</a></li><li><a href="/view/React/1.html" aria-current="page" class="active sidebar-link">React 设计模式读书笔记</a></li></ul></section></li><li><a href="/view/Young/" class="sidebar-link">Young</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/view/Rust/" class="sidebar-heading clickable"><span>Rust</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/view/Vue/" class="sidebar-heading clickable"><span>Vue</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/view/Webpack/" class="sidebar-heading clickable"><span>Webpack</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/view/TS/" class="sidebar-heading clickable"><span>TS</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/view/JS/" class="sidebar-heading clickable"><span>JS</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/view/Nodejs/" class="sidebar-heading clickable"><span>Node</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/view/DesignPattern/" class="sidebar-heading clickable"><span>设计模式</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/view/Algorithm/" class="sidebar-heading clickable"><span>算法</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/view/Linux/" class="sidebar-heading clickable"><span>Linux</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/view/Docker/" class="sidebar-heading clickable"><span>Docker</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/view/Http/" class="sidebar-heading clickable"><span>Http协议</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/view/MongoDB/" class="sidebar-heading clickable"><span>MongoDB数据库</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/view/MiniApp/" class="sidebar-heading clickable"><span>小程序</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/view/Git/" class="sidebar-heading clickable"><span>Git</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/view/Css/" class="sidebar-heading clickable"><span>Css</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/view/Less/" class="sidebar-heading clickable"><span>Less</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/view/Scss/" class="sidebar-heading clickable"><span>Scss</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/view/Vscode/" class="sidebar-heading clickable"><span>Vs Code 插件</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/view/Other/" class="sidebar-heading clickable"><span>杂记</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="react-设计模式读书笔记"><a href="#react-设计模式读书笔记" class="header-anchor">#</a> React 设计模式读书笔记</h1> <h2 id="第1章"><a href="#第1章" class="header-anchor">#</a> 第1章</h2> <p><code>UI= f(state)</code>。框架内部运行机制根据当前状态渲染视图</p> <ol><li>根据自变量state变化计算出UI变化</li> <li>根据UI变化执行具体的宿主环境API</li></ol> <p>副作用包括，调用DOM API，I/O操作，控制台打印等“函数调用过程中产生的，外部可观察的变化”都属于副作用。</p> <p>前端框架可以分为三类</p> <ol><li>应用级框架 React</li> <li>组件级框架 Vue</li> <li>元素级框架 Svelte</li></ol> <p>useRef，用于在组件多次render之间缓存一个“引用类型的值”。</p> <p>细粒度更新
在Vue和Mobx中使用的“能自动追踪依赖的技术”被称为“细粒度更新”。</p> <p>useState</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 保存了依赖了改state的effect</span>
    <span class="token keyword">const</span> subs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token function-variable function">getter</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取当前上下文的effect</span>
        <span class="token keyword">const</span> effect <span class="token operator">=</span> effectStack<span class="token punctuation">[</span>effectStack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 建立订阅关系</span>
            <span class="token function">subscribe</span><span class="token punctuation">(</span>effect<span class="token punctuation">,</span>subs<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> value
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token function-variable function">setter</span>  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">nextValue</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        value <span class="token operator">=</span> nextValue
        <span class="token comment">//通知所有订阅改state的effect执行</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> effect <span class="token keyword">of</span> <span class="token punctuation">[</span><span class="token operator">...</span>subs<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            effect<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>getter<span class="token punctuation">,</span>setter<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">effect<span class="token punctuation">,</span> subs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    subs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
    effect<span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>subs<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>age<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>sex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>useEffect</p> <ol><li>useEffect调用后，回掉函数立即执行</li> <li>依赖的自变量变化后，回调函数立即执行</li> <li>不需要显示指定依赖</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">execute</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 重置依赖</span>
        <span class="token function">cleanup</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
        <span class="token comment">// 将当前effect推入栈顶, 在useState的getter内部获取effectStack的栈顶effect及为“当前effect上下文”</span>
        effectStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
        <span class="token comment">// 执行回调</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">finally</span><span class="token punctuation">{</span>
        <span class="token comment">// effect 出栈</span>
        effectStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> effect <span class="token operator">=</span> <span class="token punctuation">{</span>
        execute<span class="token punctuation">,</span>
        <span class="token literal-property property">deps</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 该effect 依赖的state.subs</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 立即执行一次，建立订阅发布关系</span>
    <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token parameter">effect</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 从该effect订阅的所有state对应subs中移除该effect</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> subs <span class="token keyword">of</span> effect<span class="token punctuation">.</span>deps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        subs<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    effect<span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>



</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>s<span class="token punctuation">,</span>set<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span>
    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> s
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>举例</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">[</span>name1<span class="token punctuation">,</span>setName1<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>name2<span class="token punctuation">,</span>setName2<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'wolrd'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token punctuation">[</span>showAll<span class="token punctuation">,</span> triggerShowAll<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> whoIsHere <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">showAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">name1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">name1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 和 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">name2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'谁'</span><span class="token punctuation">,</span><span class="token function">whoIsHere</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我是'</span><span class="token punctuation">,</span><span class="token function">name1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">setName1</span><span class="token punctuation">(</span><span class="token string">'小明'</span><span class="token punctuation">)</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="_1-2-2-aot"><a href="#_1-2-2-aot" class="header-anchor">#</a> 1.2.2 AOT</h3> <ul><li>AOT提前编译或预编译，宿主环境获取的是编译后的代码。
<ul><li>编译时可以检测错误</li> <li>首次运行笔JIT快</li> <li>代码体积小于JIT</li></ul></li> <li>JIT即时编译，代码在宿主环境中编译并执行，运行时检测错误</li></ul> <p>Vue3的编译优化，在编译时可以标记模版语法为静态部分与动态部分。</p> <p>❗️❗️React Forget❗️❗️</p> <h3 id="virtual-dom"><a href="#virtual-dom" class="header-anchor">#</a> Virtual DOM</h3> <p>vdom是实现“根据自变量变化计算出UI变化”的一种主流技术，工作原理如下</p> <ul><li>将“元素描述的UI”转为“VDOM描述的UI” 。比如vue中的render，react中的createElement</li> <li>对比变化前后“VDOM描述的UI”。计算出UI中发生变化的部分。比如vue中的patch，react中的fiberNode</li></ul> <p>优点如下</p> <ol><li>相比较DOM的体积优势，dom包含大量冗余的属性。使用“包含较少冗余属性的vdom”，能减少内存开销</li> <li>相较于AOT更强大的描述能力。</li> <li>多平台渲染多抽象能力</li></ol> <h2 id="第2章-react理念"><a href="#第2章-react理念" class="header-anchor">#</a> 第2章 React理念</h2> <p>React是一款“重运行时”的应用级框架。</p> <p>CPU瓶颈，I/O瓶颈</p> <p>如果js执行时间过长，导致渲染流水线绘制图片的速度跟不上屏幕刷新频率，就会造成页面掉帧。表现为页面卡顿，这就是造成CPU瓶颈的原因</p> <p>react使用时间切片技术来解决这个问题，将vdom的执行过程拆分为一个个独立的宏任务，将每个宏任务的执行时间限制在一定范围内（5ms）。</p> <p>I/O瓶颈对于前端来说主要是网络延迟。</p> <ol><li>优先响应人机交互，为不同的操作赋予不同的优先级</li> <li>所有优先级统一调度，优先处理“最高优先级的更新”</li> <li>如果当前更新，有“更高优先级的更新”产生，则中断当前更新，优先处理高优先级更新</li></ol> <p>要实现上述3个要点，需要React底层实现：</p> <ol><li>用于调度优先级的调度器</li> <li>用于调度器的调度算法</li> <li>支持可中断的VDOM实现</li></ol> <p>时间切片， V16及以上都是使用新架构，旧架构不能无法实现Time slice</p> <p>新架构</p> <ol><li>Reconciler（协调器）- VDOM的实现，负责根据自变量变化计算出UI的变化</li> <li>Renderer（渲染器）- 负责将变化的UI渲染到宿主环境</li> <li>Scheduler(调度器) - 调度任务的优先级，高优先级任务优先进入Reconciler</li></ol> <p>新架构中Reconciler中的更新流程从递归变成了“可中断的循环过程”。每次循环都会调用shouldYield判断当前Time Slice是否有剩余时间，没有剩余时间则暂停更新流程，将主线程交给渲染流水线，等待下一个宏任务再继续执行，这就是Time Slice的实现原理。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">workLoopConcurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 一直执行任务，直到任务执行完成中断</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">shouldYield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">shouldYield</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当前时间是否大于过期时间</span>
    <span class="token comment">// 其中deadline = getCurrentTime() + yieldInterval</span>
    <span class="token comment">// yieldInterval为调度器的预设时间间隔，默认是5ms</span>
    <span class="token keyword">return</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> deadline
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>当Scheduler将调度后的任务交给Reconciler后，Reconciler最终会为VDOM元素标记各种副作用flags。 比如移动，插入，删除。</p> <p>Scheduler和Reconciler的工作都是在内存中进行。只有Reconciler完成工作后，才会进入Renderer</p> <p>Renderer根据“Reconciler标记各种副作用flags”执行对应的操作。</p> <h3 id="_2-2-2-主打特性的迭代"><a href="#_2-2-2-主打特性的迭代" class="header-anchor">#</a> 2.2.2 主打特性的迭代</h3> <p>React大体经历了4个发展时期</p> <ol><li>Sync（同步） - 旧架构</li> <li>Async Mode（异步模式）- 新架构</li> <li>Concurrent Mode（并发模式）- 新架构</li> <li>Concurrent Feature（并发特性）- 新架构</li></ol> <p>CPU瓶颈和I/O瓶颈，并不是同时解决的。解决CPU瓶颈的方式是“架构重构”。
重构后Reconciler的工作流由“同步”变为“异步，可中断”。因此这一个时间的React被称为Async Mode。</p> <p>单一更新的工作流程变为“同步、可中断”并不能解决I/O瓶颈，解决问题的关键在于“使多个更新的工作流程并发执行”。所以继续迭代为Concurrent Mode（并发模式）。</p> <p>React渐进升级</p> <ol><li>Legacy模式，通过<code>ReactDOM.render(&lt;APP/&gt;, rootNode)</code>创建的应用遵循该模式。默认关闭StrictMode。表现未开启并发更新</li> <li>Blocking模式。通过<code>ReactDOM.creatBlockingRoot(rootNode).render(&lt;App/&gt;)</code>创建的应用遵循该模式，作为从Legacy向Concurrent过度的中间模式，默认开启StrictMode,表现未开启并发更新，但是启用了一些新功能，（比如AutomaticBatching）</li> <li>Concurrent模式，通过ReactDOM.createRoot(rootNode).render(<App></App>)创建的应用遵循该模式，默认开启StrictMod，表现为开启并发特性</li></ol> <p>三种模式特性对比图</p> <p>Snipaste_2023-11-04_21-59-31.png</p> <p>React在18中不再提供三种开发模式，而是以“是否使用并发特性”作为“是否开启并发更新”的依据。具体说就是，开发者在v18中统一使用ReactDOM.createRoot创建应用。当不使用并发特性时，表现为未开启并发更新，但是启用了一些新功能，（比如AutomaticBatching）。当使用并发特性后表现为开启并发特性</p> <h3 id="_2-3-fiber架构"><a href="#_2-3-fiber架构" class="header-anchor">#</a> 2.3 Fiber架构</h3> <p>Fiber架构是新架构的基础。React中有三种节点类型</p> <ol><li>React Element(React元素),即createElement方法的返回值</li> <li>React Component（React 组件），开发者可以在React中定义函数，类两种类型的Component</li> <li>FiberNode，组成Fiber架构的节点类型。</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// React Component</span>
<span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>h3<span class="token operator">&gt;</span><span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>h3<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
<span class="token comment">// React Element</span>
<span class="token keyword">const</span> ele <span class="token operator">=</span> <span class="token operator">&lt;</span>App<span class="token operator">/</span><span class="token operator">&gt;</span>

<span class="token comment">// 在React运行时内部，包含App对应FiberNode</span>

ReactDOM<span class="token punctuation">.</span><span class="token function">createRoot</span><span class="token punctuation">(</span>rootNode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_2-3-1-fibernode的含义"><a href="#_2-3-1-fibernode的含义" class="header-anchor">#</a> 2.3.1 FiberNode的含义</h3> <p>FiberNode包含以下三次含义</p> <ol><li>作为架构，v15的Reconciler采用递归的方式执行，被称为Stack Reconciler。v16及以后版本的Reconciler基于FiberNode实现，被称为Fiber Reconciler</li> <li>作为“静态的数据结构”，每个FiberNode对应一个React元素，用于保存React元素的类型，对应的DOM元素等信息</li> <li>作为“动态的工作单元”，每个FiberNode用于保存“本次更新中该React元素变化的数据，要执行的工作（增删改查，更新ref，副作用等）”</li></ol> <p>双缓存，Fiber架构中同时存在两颗Fiber Tree，一颗是“真实UI对应的Fiber Tree”，可以理解为前缓冲区，另一颗是“正在内存中构建的Fiber Tree”，可以理解为后缓冲区。</p> <p>current指“前缓冲区中的FiberNode”，workInProgress指“后缓冲区的FiberNode”，alternate指向“另一个缓冲区中对应的FiberNode”
current.alternate === workInProgress
workInProgress.alternate  === current</p> <h3 id="_2-3-3-mount时fiber-tree的构建"><a href="#_2-3-3-mount时fiber-tree的构建" class="header-anchor">#</a> 2.3.3 mount时Fiber Tree的构建</h3> <p>moute时有2个情况</p> <ol><li>整个应用的首次渲染，这种情况发生在首次进入页面时</li> <li>某个组件的首次渲染，当isShow为true时，Btn组件进入mount流程，此时Btn组件所在应用可能处于update流程
<code>{isShow ? &lt;Btn/&gt; :null}</code></li></ol> <p>整个应用的首次渲染</p> <ol><li>创建fiberRootNode（情况2没有）</li> <li>创建tag为3的FiberNode，代表HostRoot，后文称该FiberNode为HostRootFiber（情况2没有）</li> <li>从HostRootFiber开始，以DFS深度优先搜索的顺序生成FiberNode</li> <li>在遍历过程中，为FiberNode标记“代表不同副作用的flags”，以便后续在Renderer中使用</li></ol> <p>HostRoot代表“应用在宿主环境挂载的根节点”，也就是“rootElement”
HostRootFiber 代表“HostRoot对应的FiberNode”
FiberRootNode负责管理该应用的全局事宜，比如</p> <ol><li>Current Fiber Tree与 Wip Fiber Tree之间的切换</li> <li>应用中任务的过期时间</li> <li>应用的任务调度信息</li></ol> <p>fiberRootNode.current === HostRootFiber</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>num<span class="token punctuation">,</span> add<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token operator">&lt;</span>p onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">add</span><span class="token punctuation">(</span>num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>num<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> rootElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span>

ReactDOM<span class="token punctuation">.</span><span class="token function">createRoot</span><span class="token punctuation">(</span>rootElement<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'&lt;App/&gt;'</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ol><li><p>fixtures: 包含一些为开发者准备的小型React测试项目</p></li> <li><p>packages: 所有与React相关的包存放于此</p> <ul><li>react-art，对应Canvas，SVG，VML</li> <li>react-dom，对应浏览器和ssr</li> <li>react-native-renderer，用于Native环境</li> <li>react-noop-renderer，用户debug Fiber</li> <li>react-test-renderer，渲染成js对象，用于测试</li> <li>react-server,创建自定义ssr流</li> <li>react-client，自定义的流数据模型</li> <li>react-interactions，用于测试交互相关的内部特性，比如react的事件模型</li> <li>react-reconciler，即Fiber Reconciler</li> <li>react-fetch用于数据请求</li> <li>react-is 用于测试“组件是否时某中类型”</li> <li>react-refresh，用于在react中使用fast refresh（类似热重载，在运行时调试 React component不会丢失状态）</li> <li>create-subscription，用于在组件内订阅React外部数据源</li></ul></li> <li><p>scripts： 各种工具链脚本，比如git，jest ，eslint</p></li></ol> <h2 id="第3章-render阶段"><a href="#第3章-render阶段" class="header-anchor">#</a> 第3章 render阶段</h2> <p>Reconciler工作的阶段在React内部被称为render阶段，classComponent的render函数，Function Component函数本身都在该阶段被调用</p> <p>performSyncWorkOnRoot 同步更新流程
performConcurrentWordOnRoot 并发更新流程</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">workLoopSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">workLoopConcurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">shouldYield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perforUnitOfWork</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span>workInProgress<span class="token punctuation">,</span>renderLanes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 执行update操作</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 执行mount</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 根据tag不同，进入不同处理逻辑</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> IndeterminateComponent <span class="token comment">// FC mount 时进入的分支，</span>
        <span class="token keyword">case</span> LazyComponent
        <span class="token keyword">case</span> FunctionComponent <span class="token comment">// FC update时进入</span>
        <span class="token keyword">case</span> ClassComponent
        <span class="token keyword">case</span> HostRoot
        <span class="token keyword">case</span> HostHoistable
        <span class="token keyword">case</span> HostComponent <span class="token comment">// 代表原声Element类型（比如DIV SPAN）</span>
        <span class="token operator">...</span>
        <span class="token operator">...</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

Reconciler 核心代码
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">current</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">workInProgress</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token literal-property property">nextChildren</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  <span class="token literal-property property">renderLanes</span><span class="token operator">:</span> Lanes<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// mount时</span>
        workInProgress<span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token function">mountChildFibers</span><span class="token punctuation">(</span>
            workInProgress<span class="token punctuation">,</span>
            <span class="token keyword">null</span><span class="token punctuation">,</span>
            nextChildren<span class="token punctuation">,</span>
            renderLanes<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    
        workInProgress<span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token function">reconcileChildFibers</span><span class="token punctuation">(</span>
            workInProgress<span class="token punctuation">,</span>
            current<span class="token punctuation">.</span>child<span class="token punctuation">,</span>
            nextChildren<span class="token punctuation">,</span>
            renderLanes<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>



<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">reconcileChildFibers</span><span class="token operator">:</span> ChildReconciler <span class="token operator">=</span> <span class="token function">createChildReconciler</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">mountChildFibers</span><span class="token operator">:</span> ChildReconciler <span class="token operator">=</span> <span class="token function">createChildReconciler</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">function</span> <span class="token function">createChildReconciler</span><span class="token punctuation">(</span>
  <span class="token literal-property property">shouldTrackSideEffects</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span> <span class="token comment">// 代表是否追踪副作用，即是否标记flags</span>
<span class="token punctuation">)</span><span class="token operator">:</span> ChildReconciler <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><h3 id="_3-3-3-位运算在-标记状态-中的应用"><a href="#_3-3-3-位运算在-标记状态-中的应用" class="header-anchor">#</a> 3.3.3 位运算在“标记状态”中的应用</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token keyword">export</span> <span class="token keyword">const</span> NoContext <span class="token operator">=</span>     <span class="token comment">/* 未处于React上下文          */</span> <span class="token number">0b000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> BatchedContext <span class="token operator">=</span>       <span class="token comment">/* 处于batchedUpdates上下文   */</span> <span class="token number">0b001</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> RenderContext <span class="token operator">=</span> <span class="token comment">/* 处于render阶段             */</span> <span class="token number">0b010</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> CommitContext <span class="token operator">=</span> <span class="token comment">/* 处于commit阶段             */</span> <span class="token number">0b100</span><span class="token punctuation">;</span>

当执行流程进入render阶段，会使用按位或标记进入对应的上下文

<span class="token keyword">let</span> executionContext <span class="token operator">=</span> NoContext
executionContext <span class="token operator">|=</span> RenderContext

<span class="token function">此时可以结合按位与和NoContext来判断“是否处于某一上下文中”</span>

<span class="token punctuation">(</span><span class="token number">0b010</span> <span class="token operator">&amp;</span> <span class="token number">0b010</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token number">0</span><span class="token function">b000</span>  
<span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> RenderContext<span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext <span class="token comment">// true</span>

<span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> CommitContext<span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext <span class="token comment">// false</span>


从当前上下文中移除 RenderContext 上下文，结合按位与，按位非移除标记

executionContext <span class="token operator">&amp;=</span> ～RenderContext

<span class="token number">0b000</span> <span class="token number">0000</span> <span class="token number">0000</span> <span class="token number">0000</span> <span class="token number">0000</span> <span class="token number">0000</span> <span class="token number">0000</span> <span class="token number">0010</span>  RenderContext

对RenderContext按位非
<span class="token number">0b111</span> <span class="token number">1111</span> <span class="token number">1111</span> <span class="token number">1111</span> <span class="token number">1111</span> <span class="token number">1111</span> <span class="token number">1111</span> <span class="token number">1101</span>  ～RenderContext

上述数据执行按位与 得到

<span class="token number">0b000</span> <span class="token number">0000</span> <span class="token number">0000</span> <span class="token number">0000</span> <span class="token number">0000</span> <span class="token number">0000</span> <span class="token number">0000</span> <span class="token number">0000</span>



</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h3 id="_3-4-completework"><a href="#_3-4-completework" class="header-anchor">#</a> 3.4 completeWork</h3> <p>completeWork也会根据wip.tag 区分对待，流程大概包括2个</p> <ol><li>创建或者标记元素更新</li> <li>flags冒泡</li></ol> <p>beginWork的reconcilerChildFibers方法用来“标记fiberNode的插入，删除，移动”。</p> <p>completeWork方法的步骤1会完成 “beginWork做的标记”。当步骤1完成后，该fiberNode在本次更新中的增删改操作均已标记完成。至此，Reconciler中“标记flags”相关工作基本完成。但是距离在Renderer中间“解析flags”还有一项重要工作，就是
”flags冒泡“</p> <p>当流程经过Reconciler后，会得到一个Wip Fiber Tree，部分fiberNode被标记flags。
Renderer需要对“被标记的fiberNode对应的DOM元素”执行“flags对应的DOM操作”。那么如何高效的找到这些散落在
Wip Fiber Tree各处的“被标记的fiberNode”，这就是flags冒泡的作用。</p> <p>我们知道，completeWork属于归的阶段。从叶子元素开始，流程自下而上，fiberNode.subtreeFlags记录了
该fiberNode的“所有子孙fiberNode上被标记的flags”，每个fiberNode经过如下操作，可以将子孙fiberNode中
“标记的flags”向上冒泡一层</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> subtreeFlags <span class="token operator">=</span> NoFlags
<span class="token comment">// 收集子fiberNode的子孙fiberNode中标记的flags</span>
subtreeFlags <span class="token operator">|=</span>  child<span class="token punctuation">.</span>subtreeFlags

<span class="token comment">// 收集子fiberNode标记的flags</span>
subtreeFlags <span class="token operator">|=</span>  child<span class="token punctuation">.</span>flags

<span class="token comment">// 附加在当前fiberNode的subtreeFlags上</span>

completeWork<span class="token punctuation">.</span>subtreeFlags <span class="token operator">|=</span> subtreeFlags



</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>completeWork 在mount时的流程总结如下</p> <ol><li>根据wip.tag进入不同处理分支</li> <li>根据current！=null区分是mount还是update</li> <li>对于HostComponent，首先执行createInstance方法创建对应的DOM元素</li> <li>执行appendAllChildren将下一级DOM元素挂载在步骤（3）创建的DOM元素</li> <li>执行finalizeInitialChildren完成属性初始化</li> <li>执行bubbleProerties完成flags冒泡</li></ol> <h3 id="_3-4-3-update概览"><a href="#_3-4-3-update概览" class="header-anchor">#</a> 3.4.3 update概览</h3> <p>update流程将完成标记属性的更新。主要是diffProperties。包括</p> <ol><li>第一次遍历，标记删除“更新前有，更新后没有”的属性</li> <li>第二次遍历，标记更新”update流程前后发生改变“的属性</li></ol> <p>diffProperties,所有变化属性的key，value会保存在fiberNode.updateQueue中，同时，该fiberNode会标记Update</p> <p>workInProgress.flags |= Update</p> <p>在updateQueue中，数据以key，value作为数组的相邻两项。如下</p> <p>['title','1','style',{'color':&quot;red&quot;}]</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="第4章-commit-阶段"><a href="#第4章-commit-阶段" class="header-anchor">#</a> 第4章 commit 阶段</h2> <p>Renderer工作的阶段被称为commit阶段，在commit阶段，会将各种副作用（flags标记）commit（提交）到宿主环境的Ui中。</p> <p>render阶段流程可能被打断，而commit阶段一旦开始就会同步执行直到完成。整个阶段可以分为3个阶段</p> <ol><li>BeforeMutaion阶段</li> <li>Mutation 阶段</li> <li>Layout 阶段</li></ol> <p>commit阶段的起点开始于commitRoot方法的调用</p> <p>commitRoot(root);</p> <ul><li>root代表“本次更新所属FiberRootNode”</li> <li>root.finishedWork代表Wip HostRootFiber，即“render阶段构建的 Wip FIber Tree”的HostRootFiber</li></ul> <p>在三个子阶段执行前，需要判断本次更新是否涉及“与三个子阶段相关的副作用”</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// subtreeHasEffects 代表Wip HostRootFiber的子孙元素存在的副作用flags</span>
  <span class="token keyword">const</span> subtreeHasEffects <span class="token operator">=</span>
    <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>subtreeFlags <span class="token operator">&amp;</span>
      <span class="token punctuation">(</span>BeforeMutationMask <span class="token operator">|</span> MutationMask <span class="token operator">|</span> LayoutMask <span class="token operator">|</span> PassiveMask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span>
    NoFlags<span class="token punctuation">;</span>
<span class="token comment">// rootHasEffect 代表 Wip HostRootFiber 本身存在的副作用flags。</span>
  <span class="token keyword">const</span> rootHasEffect <span class="token operator">=</span>
    <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span>
      <span class="token punctuation">(</span>BeforeMutationMask <span class="token operator">|</span> MutationMask <span class="token operator">|</span> LayoutMask <span class="token operator">|</span> PassiveMask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span>
    NoFlags<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>subtreeHasEffects <span class="token operator">||</span> rootHasEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 进入三个阶段</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 省略本次更新没有三个子阶段的副作用</span>
  <span class="token punctuation">}</span>


<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">BeforeMutationMask</span><span class="token operator">:</span> number <span class="token operator">=</span>
  <span class="token comment">// TODO: Remove Update flag from before mutation phase by re-landing Visibility</span>
  <span class="token comment">// flag logic (see #20043)</span>
  Update <span class="token operator">|</span>
  Snapshot <span class="token operator">|</span>
  <span class="token punctuation">(</span>enableCreateEventHandleAPI
    <span class="token operator">?</span> <span class="token comment">// createEventHandle needs to visit deleted and hidden trees to</span>
      <span class="token comment">// fire beforeblur</span>
      <span class="token comment">// TODO: Only need to visit Deletions during BeforeMutation phase if an</span>
      <span class="token comment">// element is focused.</span>
      ChildDeletion <span class="token operator">|</span> Visibility
    <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> MutationMask <span class="token operator">=</span>
  Placement <span class="token operator">|</span>
  Update <span class="token operator">|</span>
  ChildDeletion <span class="token operator">|</span>
  ContentReset <span class="token operator">|</span>
  Ref <span class="token operator">|</span>
  Hydrating <span class="token operator">|</span>
  Visibility<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> LayoutMask <span class="token operator">=</span> Update <span class="token operator">|</span> Callback <span class="token operator">|</span> Ref <span class="token operator">|</span> Visibility<span class="token punctuation">;</span>

<span class="token comment">// TODO: Split into PassiveMountMask and PassiveUnmountMask</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> PassiveMask <span class="token operator">=</span> Passive <span class="token operator">|</span> Visibility <span class="token operator">|</span> ChildDeletion<span class="token punctuation">;</span>




</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>They're used by React Dev Tools.</p> <ul><li><p>Placement：当前fiberNode或子孙fiberNode存在“需要插入或移动的HostComponent或HostText”</p></li> <li><p>Hydrating：hydrate相关</p></li> <li><p>Update classComponet存在更新，且定义了componentDidMount或者componentDidUpdate方法；HostComponent发生属性变化；HostText发生内容变化；Fc定义了useLayoutEffect</p></li></ul> <p>Skipped value</p> <ul><li>ChildDeletion有“需要被删除的子HostComponent或子HostText”</li> <li>ContentReset 清空HostComponent的文本内容</li> <li>Callback：当calssComponent中的this.setState执行时，或ReactDOM.render执行时传递了回调函数参数</li></ul> <p>Used by DidCapture</p> <ul><li>Ref：HostComponent ref属性的创建与更新</li> <li>Snapshot；ClassComponent存在更新，且定义了getSnapshotBeforeUpdate方法</li> <li>Passive ：Fc中定义了useEffect且需要触发回调函数</li></ul> <p>Used by Hydrating</p> <ul><li>Visibility：控制SuspenseComponent的子树与fallback切换时子树的显隐</li></ul> <h2 id="第5章-schedule阶段"><a href="#第5章-schedule阶段" class="header-anchor">#</a> 第5章 schedule阶段</h2> <p>Scheduler为“Time Slice分割出的一个个短宏任务”提供了执行的驱动力</p> <p>为了更灵活的控制宏任务的执行时机，React实现了一套基于lane模型的优先级算法，
并基于这套算法实现了Batched Updates（批量更新），任务打断/恢复机制等低级特性。
基于低级特性，React实现了“面向开发者”的高级特性（也叫并发特性），比如Concurrent Suspense ，useTransition</p> <p>Scheduler预设了5中优先级，优先级依次降低</p> <ul><li>ImmediatePriority(最高优先级，同步执行)</li> <li>UserBlockingPriority</li> <li>NormalPriority</li> <li>LowPriority</li> <li>IdleOriority（最低优先级）</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">scheduleCallback</span><span class="token punctuation">(</span>LowPriority<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
执行上述函数后返回
task <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">expirationTIme</span><span class="token operator">:</span> startTime <span class="token operator">+</span> timeout<span class="token punctuation">,</span>
    <span class="token literal-property property">callback</span><span class="token operator">:</span>fn
<span class="token punctuation">}</span>

expirationTIme 由scheduleCallback执行时的时间 <span class="token operator">+</span> timeout（不同优先级对应的timeout）

Scheduler将expirationTIme字段作为“task之间排序的依据”，值越小优先级越高，高优先级的task<span class="token punctuation">.</span>callback在新的宏任务重优先执行。这就是Scheduler调度的原理


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>Scheduler简易实现</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 保存所有work</span>
<span class="token keyword">const</span> workList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment">// 上一次执行perform的work对应优先级</span>
<span class="token keyword">let</span> pervPriority  <span class="token operator">=</span> IdlePriority

<span class="token comment">// 当前调度的callback</span>
<span class="token keyword">let</span> curCallback

<span class="token keyword">function</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取“当前正在调度的callback”</span>
    <span class="token keyword">const</span> cbNode <span class="token operator">=</span> <span class="token function">getFirstCallbackNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 取出最高优先级的工作</span>
    <span class="token keyword">const</span> curWork <span class="token operator">=</span> workList<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">w1<span class="token punctuation">,</span>w2</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> w1<span class="token punctuation">.</span>priority <span class="token operator">-</span> w2<span class="token punctuation">.</span>priority<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    <span class="token comment">// 以下直到“赋值curCallback”之前都是策略逻辑</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>curWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 没有work需要调度，返回</span>
        curCallback <span class="token operator">=</span> <span class="token keyword">null</span>
        cbNode <span class="token operator">&amp;&amp;</span> <span class="token function">cancelIdleCallback</span><span class="token punctuation">(</span>cbNode<span class="token punctuation">)</span>
        <span class="token keyword">return</span> 
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取当前最高优先级work的优先级</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span><span class="token literal-property property">priority</span><span class="token operator">:</span>curPriority<span class="token punctuation">}</span> <span class="token operator">=</span> curWork
    <span class="token keyword">if</span><span class="token punctuation">(</span>curPriority <span class="token operator">===</span> prevPriority<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果优先级相同，则不需要调度，退出调度</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 准备调度当前最高优先级的work</span>
    <span class="token comment">// 调度之前，如果有工作在进行，则中断它</span>

    cbNode <span class="token operator">&amp;&amp;</span> <span class="token function">cancelIdleCallback</span><span class="token punctuation">(</span>cbNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 调度当前最高优先级的work</span>
    curCallback <span class="token operator">=</span> <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>curPriority<span class="token punctuation">,</span><span class="token function">perform</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>curWork<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token punctuation">}</span>


<span class="token keyword">function</span> <span class="token function">perform</span><span class="token punctuation">(</span><span class="token parameter">work<span class="token punctuation">,</span>didTimeout</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// didTimeout 解决饥饿问题不断的插入高优先级任务，导致低优先任务无法执行</span>
    <span class="token keyword">const</span> needSync <span class="token operator">=</span> work<span class="token punctuation">.</span>priority <span class="token operator">===</span> ImmdiatePriority <span class="token operator">||</span> didTimeout<span class="token punctuation">;</span>
    <span class="token comment">// 同步执行 ，如果</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>needSync <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">shouldYield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> work<span class="token punctuation">.</span>count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        work<span class="token punctuation">.</span>count <span class="token operator">--</span>
        <span class="token function">inserItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 跳出循环，prevPriority 代表上一次执行的优先级</span>
    prevPriority <span class="token operator">=</span> work<span class="token punctuation">.</span>priority

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>work<span class="token punctuation">.</span>count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从workList 中删除完成的work</span>
        <span class="token keyword">const</span> workIndex <span class="token operator">=</span> workList<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>work<span class="token punctuation">)</span>
        workList<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>workIndex<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment">// 重置优先级</span>

        prevPriority <span class="token operator">=</span> IdlePriority
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> pervCallback <span class="token operator">=</span> curCallback
    <span class="token comment">// 调度完成后，如果callback发生变化，代表这是新的work</span>

    <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> newCallback <span class="token operator">=</span> curCallback
    <span class="token keyword">if</span><span class="token punctuation">(</span>newCallback <span class="token operator">&amp;&amp;</span> pervCallback <span class="token operator">===</span> newCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// callback不变，代表同一个work，只不过Time Slice时间用尽</span>
        <span class="token comment">// 返回的函数会被Scheduler继续调用</span>
        <span class="token keyword">return</span> <span class="token function">perform</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>work<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 移除task</span>
<span class="token keyword">function</span> <span class="token function">cancelCallback</span><span class="token punctuation">(</span><span class="token parameter">task</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    task<span class="token punctuation">.</span>callback <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>

<span class="token comment">// 用于“以某一优先级调度callback”</span>
<span class="token keyword">function</span> <span class="token function">scheduleCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

<span class="token punctuation">}</span>
<span class="token comment">// 用于“提示Time Slice时间是否用尽”，作为中断循环的一个依据</span>
<span class="token keyword">function</span> <span class="token function">shouldYield</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br></div></div><p>注意 delay 和 expirationTime</p> <p>delay代表task需要延迟执行的时间，在scheduleCallback方法中配置，“配置delay后的task”会先进入
timerQueue中。当delay对应的时间后，task会从timerQueue中取出并移入taskQueue中。</p> <p>expirationTime代表“task的过期时间”，不是所有的task都会有delay。没有配置delay的task
直接进入taskQueue</p> <p>expirationTime用于解决饥饿问题，也会用这个对task进行排序</p> <p>使用小顶堆堆数据结构实现优先级队列，push和pop的时间复杂度是O(log n)，peek操作的时间复杂度是O(1)</p> <p>小顶堆特点：</p> <ul><li>是一个完全二叉树，（初最后一层外，其他层的节点个数都是满的，且最后一层节点靠左排列）</li> <li>堆中每一个节点的值都小于等于其子树的每一个值。</li></ul> <p>宏任务的选择
requestIdleCallback问题</p> <ul><li>兼容问题</li> <li>执行频率不稳定，受很多因素影响，比如切换tab后，之前tab注册的rIC执行的频率会大幅下降</li> <li>应用场景局限</li></ul> <p>rIC的设计初衷是“能够在事件循环中执行低优先级工作”，减少对动画，用户输入等高优先级事件等影响。这意味着rIC
的应用场景被局限在“低优先级工作”中，这与Scheduler中“多中高优先级的调度策略不符合”</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> schedulePerformWorkUntilDeadline
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> localSetImmediate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 使用setImmediate(performWorkUntilDeadine)</span>
    <span class="token function-variable function">schedulePerformWorkUntilDeadline</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">localSetImmediate</span><span class="token punctuation">(</span>performWorkUntilDeadline<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> MessageChannel <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用MessageChannel实现</span>
    <span class="token keyword">let</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> port <span class="token operator">=</span> channel<span class="token punctuation">.</span>port2
    channel<span class="token punctuation">.</span>port1<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> performWorkUntilDeadline<span class="token punctuation">;</span>
    <span class="token function-variable function">schedulePerformWorkUntilDeadline</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用setTimeout实现</span>
    <span class="token function-variable function">schedulePerformWorkUntilDeadline</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">localsetTimeout</span><span class="token punctuation">(</span>performWorkUntilDeadline<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="_5-3-lane模型"><a href="#_5-3-lane模型" class="header-anchor">#</a> 5.3 lane模型</h3> <p>由于React与Scheduler的优先级并不通用，因此React选出优先级提交给Scheduler前会进行转换。
Scheduler的5种优先级</p> <ul><li>NoPriority = 0</li> <li>ImmdiatePriority = 1</li> <li>UserBlockingPriority = 2</li> <li>NormalPriority = 3</li> <li>LowPriority = 4</li> <li>IdlePriority = 5</li></ul> <p>Scheduler并不与React共用一套优先级体系，React有4种优先级</p> <ul><li>DiscreteEventPriority = SyncLane  离散事件的优先级 ，比如click，input，focus，blur，touchstart等</li> <li>ContinuousEventPriority = InputContinuousLane 连续事件的优先级 ，比如drag，mousemove，scroll， touchmove，wheel等</li> <li>DefaultEventPriority = DefaultLane 对应默认的优先级，比如通过计时器周期性触发更新。这种情况产生的update不属于“交互产生的update”，所以优先级是默认的优先级</li> <li>IdleEventPriority = IdleLane，对应空闲情况的优先级</li></ul> <p>从react到Scheduler，优先级需要经过如下2次转会</p> <ol><li>将lanes转会EventPriority，涉及到方法如下，经过转换，返回到是EventPriority</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">lanesToEventPriority</span><span class="token punctuation">(</span><span class="token parameter">lanes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取lanes中优先级最高的lane</span>

    <span class="token keyword">let</span> lane <span class="token operator">=</span> <span class="token function">getHighestPriorityLane</span><span class="token punctuation">(</span>lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果优先级高于DiscreteEventPriority,返回DiscreteEventPriority</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isHighrEventPriority</span><span class="token punctuation">(</span>DiscreteEventPriority<span class="token punctuation">,</span>lane<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> DiscreteEventPriority
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果优先级高于ContinuousEventPriority,返回ContinuousEventPriority</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isHighrEventPriority</span><span class="token punctuation">(</span>ContinuousEventPriority<span class="token punctuation">,</span>lane<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> ContinuousEventPriority
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果包含 非Idle的任务，返回DefaultEventPriority</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">includesNonIdleWork</span><span class="token punctuation">(</span>lane<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> DefaultEventPriority
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><ol start="2"><li>将EventPriority转化为Scheduler优先级，具体逻辑如下</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> schedulerPriorityLevel<span class="token punctuation">;</span>

<span class="token comment">// lanes转化为EventPriority</span>

<span class="token keyword">switch</span><span class="token punctuation">(</span><span class="token function">lanesToEventPriority</span><span class="token punctuation">(</span>nextLanes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token literal-property property">DiscreteEventPriority</span><span class="token operator">:</span>
        schedulerPriorityLevel <span class="token operator">=</span> ImmdiatePriority
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token literal-property property">ContinuousEventPriority</span><span class="token operator">:</span>
        schedulerPriorityLevel <span class="token operator">=</span> UserBlockingPriority
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token literal-property property">DefaultEventPriority</span><span class="token operator">:</span>
        schedulerPriorityLevel <span class="token operator">=</span> NormalPriority
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token literal-property property">IdleEventPriority</span><span class="token operator">:</span>
        schedulerPriorityLevel <span class="token operator">=</span> IdlePriority
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
        schedulerPriorityLevel <span class="token operator">=</span> NormalPriority
        <span class="token keyword">break</span><span class="token punctuation">;</span>
                   
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/view/React/2.html" class="prev">
        Hook
      </a></span> <span class="next"><a href="/view/Young/">
        Young
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.fd8d9560.js" defer></script><script src="/assets/js/2.a8ceb4c3.js" defer></script><script src="/assets/js/1.927044d1.js" defer></script><script src="/assets/js/209.e0c2863e.js" defer></script>
  </body>
</html>
